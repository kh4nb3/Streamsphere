{% extends 'base.html' %}

{% block content %}
<div class="detail-container" style="margin-top: 100px;">
    {% if movie %}
    <div class="row">
        <div class="col-lg-8">
            <div class="video-placeholder">
                <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="video-bg">
                <i class="fas fa-play-circle play-button"></i>
            </div>
            <h1 class="mb-3 fw-bold">{{ movie.title }}</h1>
            <div class="d-flex align-items-center gap-3 mb-4">
                <span class="badge bg-secondary">{{ movie.year }}</span>
                <span>{{ movie.formatted_duration }}</span>
                <span><i class="fas fa-star text-warning"></i> {{ movie.average_rating|default:"--" }}</span>
                <span class="badge bg-info">{{ movie.rating }}</span>
                {% for genre in movie.genres.all %}
                    <span class="badge bg-outline-secondary">{{ genre.name }}</span>
                {% endfor %}
            </div>
            
            <!-- User Actions -->
            {% if user.is_authenticated %}
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-success btn-sm" onclick="toggleWatchlist({{ movie.id }})">
                    <i class="fas fa-{% if in_watchlist %}heart{% else %}heart-o{% endif %}"></i>
                    <span id="watchlist-text">{% if in_watchlist %}Remove from Watchlist{% else %}Add to Watchlist{% endif %}</span>
                </button>
                <div class="rating-container">
                    <span>Rate this movie:</span>
                    <div class="star-rating" data-movie-id="{{ movie.id }}">
                        {% for i in "12345" %}
                        <i class="fas fa-star{% if user_rating and user_rating.rating >= i|add:0 %} text-warning{% endif %}" 
                           data-rating="{{ i }}" onclick="rateMovie({{ movie.id }}, {{ i }})"></i>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <p class="lead text-light mb-5">{{ movie.description }}</p>

            <!-- Reviews Section -->
            <div class="comment-section">
                <h3 class="mb-4">Reviews ({{ recent_reviews.count }})</h3>
                {% for review in recent_reviews %}
                <div class="comment">
                    <div class="d-flex justify-content-between mb-2">
                        <strong class="text-primary">{{ review.user.username }}</strong>
                        <small class="">{{ review.created_at|timesince }} ago</small>
                    </div>
                    <div class="mb-2">
                        {% for i in "12345" %}
                        <i class="fas fa-star{% if review.rating >= i|add:0 %} text-warning{% endif %}"></i>
                        {% endfor %}
                    </div>
                    <p class="mb-0 text-light">{{ review.review }}</p>
                </div>
                {% empty %}
                <p class="text-muted">No reviews yet. Be the first to review this movie!</p>
                {% endfor %}

                {% if user.is_authenticated %}
                <div class="mt-4">
                    <textarea class="form-control mb-3 light-placeholder" rows="3" id="review-text"
                        placeholder="Write a review...">{% if user_rating.review %}{{ user_rating.review }}{% endif %}</textarea>
                    <button class="btn btn-primary" onclick="submitReview({{ movie.id }})">
                        {% if user_rating %}Update Review{% else %}Post Review{% endif %}
                    </button>
                </div>
                {% else %}
                <div class="mt-4">
                    <p class="text-muted"><a href="{% url 'login' %}">Login</a> to write a review.</p>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="col-lg-4">
            <h3 class="mb-4">More Like This</h3>
            <div class="d-flex flex-column gap-3">
                {% for related_movie in related_movies %}
                <a href="{% url 'movie_detail' related_movie.id %}" class="d-flex gap-3 align-items-center bg-dark p-2 rounded text-decoration-none">
                    <img src="{{ related_movie.poster }}" alt="{{ related_movie.title }}" 
                         style="width: 80px; height: 60px; object-fit: cover; border-radius: 4px;">
                    <div>
                        <h6 class="mb-1 text-light">{{ related_movie.title }}</h6>
                        <small class="text-muted">{{ related_movie.year }}</small>
                        <div>
                            <i class="fas fa-star text-warning"></i>
                            <small>{{ related_movie.average_rating|default:"--" }}</small>
                        </div>
                    </div>
                </a>
                {% empty %}
                <p class="text-muted">No related movies found.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center">
        <h2>Movie not found</h2>
        <p>The movie you're looking for doesn't exist.</p>
        <a href="{% url 'home' %}" class="btn btn-primary">Back to Home</a>
    </div>
    {% endif %}
</div>

<script>
function toggleWatchlist(movieId) {
    fetch('/api/watchlist/toggle/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({movie_id: movieId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const text = document.getElementById('watchlist-text');
            const icon = text.previousElementSibling;
            if (data.in_watchlist) {
                text.textContent = 'Remove from Watchlist';
                icon.className = 'fas fa-heart';
            } else {
                text.textContent = 'Add to Watchlist';
                icon.className = 'fas fa-heart-o';
            }
        }
    });
}

function rateMovie(movieId, rating) {
    fetch('/api/rate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({movie_id: movieId, rating: rating})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update star display
            const stars = document.querySelectorAll('.star-rating i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-warning');
                } else {
                    star.classList.remove('text-warning');
                }
            });
        }
    });
}

function submitReview(movieId) {
    const reviewText = document.getElementById('review-text').value;
    const currentRating = document.querySelectorAll('.star-rating i.text-warning').length;
    
    if (!currentRating) {
        alert('Please rate the movie first!');
        return;
    }
    
    fetch('/api/rate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            movie_id: movieId, 
            rating: currentRating,
            review: reviewText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show new review
        }
    });
}
</script>
{% endblock %}